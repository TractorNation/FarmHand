name: Android Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release Android App
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Verify TypeScript setup
        run: |
          echo "TypeScript version:"
          npx tsc --version
          echo "Node version:"
          node --version
          echo "npm version:"
          npm --version
          echo "Checking if source files exist:"
          ls -la src/utils/ | head -10
          ls -la src/ui/ | head -10
          echo "Checking Fonts.ts:"
          test -f src/utils/Fonts.ts && echo "Fonts.ts exists" || echo "Fonts.ts NOT FOUND"
          echo "Checking StoreManager.ts:"
          test -f src/utils/StoreManager.ts && echo "StoreManager.ts exists" || echo "StoreManager.ts NOT FOUND"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 36
          build-tools: 36.0.0

      - name: Setup Android Keystore
        run: |
          cd src-tauri/gen/android
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" > keystore.properties
          echo "password=${{ secrets.ANDROID_KEY_PASSWORD }}" >> keystore.properties
          base64 -d <<< "${{ secrets.ANDROID_KEY_BASE64 }}" > $RUNNER_TEMP/keystore.jks
          echo "storeFile=$RUNNER_TEMP/keystore.jks" >> keystore.properties

      - name: Build Android App
        run: |
          # Clear any potential caches
          rm -rf node_modules/.cache
          rm -rf dist
          
          # Clean Rust build cache for a fresh build
          echo "Cleaning Rust build cache..."
          cargo clean --target aarch64-linux-android 2>/dev/null || true
          
          # Clean Android build to remove any cached references to old architectures
          cd src-tauri/gen/android
          ./gradlew clean || true
          cd ../../..
          
          # Temporarily modify tauri.conf.json to use build:ci script instead of build
          cd src-tauri
          # Use sed to replace the beforeBuildCommand
          sed -i.bak 's/"beforeBuildCommand": "npm run build"/"beforeBuildCommand": "npm run build:ci"/' tauri.conf.json
          cd ..
          
          # Gradle properties are already set in gradle.properties to exclude armv7
          
          # Now build the Android app
          npm run tauri android build --release
          
          # Restore the original config
          cd src-tauri
          mv tauri.conf.json.bak tauri.conf.json
          cd ..
        env:
          CI: false

      - name: Find APK and AAB files
        id: find-artifacts
        run: |
          # Look for release builds first, then fall back to any build
          APK_PATH=$(find src-tauri/gen/android/app/build/outputs -path "*/release/*.apk" -type f | head -1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find src-tauri/gen/android/app/build/outputs -name "*.apk" -type f | head -1)
          fi

          AAB_PATH=$(find src-tauri/gen/android/app/build/outputs -path "*/release/*.aab" -type f | head -1)
          if [ -z "$AAB_PATH" ]; then
            AAB_PATH=$(find src-tauri/gen/android/app/build/outputs -name "*.aab" -type f | head -1)
          fi

          if [ -n "$APK_PATH" ]; then
            echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
            echo "apk_name=$(basename $APK_PATH)" >> $GITHUB_OUTPUT
            echo "apk_found=true" >> $GITHUB_OUTPUT
          else
            echo "apk_found=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "$AAB_PATH" ]; then
            echo "aab_path=$AAB_PATH" >> $GITHUB_OUTPUT
            echo "aab_name=$(basename $AAB_PATH)" >> $GITHUB_OUTPUT
            echo "aab_found=true" >> $GITHUB_OUTPUT
          else
            echo "aab_found=false" >> $GITHUB_OUTPUT
          fi

          # Debug: List all found files
          echo "Found APK files:"
          find src-tauri/gen/android/app/build/outputs -name "*.apk" -type f || true
          echo "Found AAB files:"
          find src-tauri/gen/android/app/build/outputs -name "*.aab" -type f || true

      - name: Extract version from package.json
        id: get-version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Parse CHANGELOG
        id: changelog
        run: |
          # Extract the latest version section from CHANGELOG.md
          # This script extracts everything from the first ## [version] to the next ## or end of file
          VERSION_TAG="${{ steps.get-version.outputs.tag }}"

          # Remove the 'v' prefix if present for matching
          VERSION_NUM=$(echo "$VERSION_TAG" | sed 's/^v//')

          # Extract changelog content for the latest version
          # Look for the version in brackets like [0.2.0-beta]
          awk -v version="$VERSION_NUM" '
            /^## \[/ {
              if (found) exit
              if ($0 ~ "\\[" version "\\]") {
                found = 1
                next
              }
            }
            found {
              if (/^## \[/) exit
              print
            }
          ' CHANGELOG.md > /tmp/changelog_content.txt

          # Read the changelog content
          CHANGELOG_CONTENT=$(cat /tmp/changelog_content.txt)

          # If changelog is empty, use a default message
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="Release $VERSION_TAG"
          fi

          # Save to file for use in release creation
          echo "$CHANGELOG_CONTENT" > /tmp/release_body.txt

      - name: Create or Update Release
        id: create-release
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          TAG="${{ steps.get-version.outputs.tag }}"
          IS_PRERELEASE="false"

          if [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"alpha"* ]]; then
            IS_PRERELEASE="true"
          fi

          # Check if release already exists
          if gh release view "$TAG" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            echo "Release $TAG already exists, updating..."
            gh release edit "$TAG" \
              --title "Release $TAG" \
              --notes-file /tmp/release_body.txt \
              --prerelease="$IS_PRERELEASE" \
              --repo "${{ github.repository }}"
          else
            echo "Creating new release $TAG..."
            gh release create "$TAG" \
              --title "Release $TAG" \
              --notes-file /tmp/release_body.txt \
              --prerelease="$IS_PRERELEASE" \
              --repo "${{ github.repository }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK to Release
        if: steps.find-artifacts.outputs.apk_found == 'true'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ steps.find-artifacts.outputs.apk_path }}
          asset_name: ${{ steps.find-artifacts.outputs.apk_name }}
          tag: ${{ steps.get-version.outputs.tag }}
          overwrite: true

      - name: Upload AAB to Release
        if: steps.find-artifacts.outputs.aab_found == 'true'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ steps.find-artifacts.outputs.aab_path }}
          asset_name: ${{ steps.find-artifacts.outputs.aab_name }}
          tag: ${{ steps.get-version.outputs.tag }}
          overwrite: true
