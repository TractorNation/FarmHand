name: Android Build and Release

# Required GitHub Secrets:
# - ANDROID_KEYSTORE_PASSWORD: Password for the Android keystore
# - ANDROID_KEY_ALIAS: Alias of the key in the keystore (e.g., "farmhand")
# - ANDROID_KEYSTORE_BASE64: Base64-encoded content of the .jks keystore file
#   To encode: base64 -i keystore.jks | pbcopy (macOS) or base64 keystore.jks (Linux)

on:
  workflow_dispatch:
  push:
    branches:
      - dev

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Extract version from package.json
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Will create/update release with tag: v$VERSION"

      - name: Setup Android signing
        run: |
          mkdir -p src-tauri/gen/android
          echo "password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> src-tauri/gen/android/keystore.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> src-tauri/gen/android/keystore.properties
          echo "storeFile=${{ github.workspace }}/keystore.jks" >> src-tauri/gen/android/keystore.properties

          # Decode base64 keystore file and save it
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks

      - name: Setup Android NDK
        run: |
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;26.1.10909125"

      - name: Build Android APK
        run: npm run tauri android build -- --target aarch64
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/26.1.10909125
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Find and rename APK
        id: apk_path
        run: |
          # Look for universal APK first, then any release APK
          APK_PATH=$(find src-tauri/gen/android/app/build/outputs/apk -name "*universal*.apk" -o -name "*release*.apk" | grep -v debug | head -n 1)

          # If not found, search more broadly
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find src-tauri/gen/android/app/build/outputs/apk -name "*.apk" -type f | grep -v debug | head -n 1)
          fi

          # Last resort: search entire android directory
          if [ -z "$APK_PATH" ]; then
            echo "APK not found in expected location. Searching entire android directory..."
            find src-tauri/gen/android -name "*.apk" -type f | head -5
            exit 1
          fi

          echo "Found APK at: $APK_PATH"
          ls -lh "$APK_PATH"

          # Determine architecture from APK path or build target
          # Try to detect from APK path first (e.g., .../arm64-v8a/...)
          if echo "$APK_PATH" | grep -q "arm64-v8a"; then
            ARCH="arm64-v8a"
          elif echo "$APK_PATH" | grep -q "armeabi-v7a"; then
            ARCH="armeabi-v7a"
          elif echo "$APK_PATH" | grep -q "x86_64"; then
            ARCH="x86_64"
          elif echo "$APK_PATH" | grep -q "x86"; then
            ARCH="x86"
          elif echo "$APK_PATH" | grep -qi "universal"; then
            ARCH="universal"
          else
            # Default to aarch64 based on your build target
            ARCH="aarch64"
          fi

          VERSION="${{ steps.package_version.outputs.version }}"
          
          # Create a descriptive filename: farmhand-v0.2.0-beta-aarch64.apk
          NEW_APK_NAME="farmhand-v${VERSION}-${ARCH}.apk"
          NEW_APK_PATH="${GITHUB_WORKSPACE}/${NEW_APK_NAME}"
          
          # Copy and rename the APK
          cp "$APK_PATH" "$NEW_APK_PATH"
          
          echo "Renamed APK to: $NEW_APK_NAME"
          echo "Detected architecture: $ARCH"
          echo "path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          ls -lh "$NEW_APK_PATH"

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          CHANGELOG=$(node scripts/extract-changelog.js "$VERSION")
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package_version.outputs.tag }}
          name: Release ${{ steps.package_version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          files: ${{ steps.apk_path.outputs.path }}
          draft: false
          prerelease: ${{ contains(steps.package_version.outputs.version, '-') || contains(steps.package_version.outputs.version, 'beta') || contains(steps.package_version.outputs.version, 'alpha') }}
          make_latest: ${{ !contains(steps.package_version.outputs.version, '-') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup sensitive files
        run: |
          rm -f keystore.jks
          rm -f src-tauri/gen/android/keystore.properties
